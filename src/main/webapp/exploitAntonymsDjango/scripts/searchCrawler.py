import urllib
from bs4 import BeautifulSoup as soup
import requests
import webbrowser
import csv

# open CSV file for writing, using DictWriter so will need DictReader later
with open('resultsLedger.csv', 'w', newline='') as csvFile:
    fieldNames = ['webpage', 'title', 'snippet']
    # original order and searched query can be inferred by the filename (webpage)
    theWriter = csv.DictWriter(csvFile, fieldnames = fieldNames)

    theWriter.writeheader()


    # set the query, '+' instead of ' '
    query = 'good laptop for university student'
    query = urllib.parse.quote_plus(query)

    # number of results we want
    numOfRes = 100

    # base google search url + query + number of results we want
    url = 'https://google.com/search?q=' + query + '&num=' + str(numOfRes)

    # get response from google
    response = requests.get(url)

    # use beautiful soup to process the results page
    web_soup = soup(response.text, 'html')

    
    # for each result in page, keep important information
    counter = 1
    for res in web_soup.find_all(class_='g'):
        #print('-----')
        if res.h3:
                href = res.h3.a['href'][7:]
                # let's unwrap useful info
                if href.startswith('h'):
                    ends = href.find('&')
                    href = href[:ends]
                    title = res.h3.text
                    snippet = res.find(class_='st').text
                    #print('Title: ' + title)
                    #print('Link: ' + href)
                    #print('Snippet: ' + snippet)

                    # download the landing page of the result and write it to a file
                    new_response = requests.get(href)
                    webPageFileName = query + str(counter) + '.html'
                    new_file = open(webPageFileName, 'w')
                    new_file.write(new_response.text)
                    new_file.close()
                    
                    # write new row to csv file
                    theWriter.writerow({'webpage' : webPageFileName, 'title' : title, 'snippet' : snippet})
                    
                    #print('Wrote to file: '+ query+str(counter))
                    counter = counter + 1
                else:
                    continue