/* global parseInt */
var queryOptions;
var queryOptionsR;

var baseColorHexStr = 'f5f5f5';
var baseColorHexInt = parseInt(baseColorHexStr, 16);

var lTempNamesArr;

function getQueriesUsed() {
    let experimentID = $('#id').val();
    var http = new XMLHttpRequest();
    var url = "getQueriesServlet";

    //  Clear out dual query part of the screen
    $('#searchR').html('');

    http.open("POST", url, true);
    
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    
    http.onreadystatechange = function() {
        if(http.readyState === 4 && http.status === 200) {
            let allQueries = http.responseText.replace(/\[/g, "").replace(/\]/g, "")
                .split(',').map(x => x.trim());
            let options = ''; 
            for (let i in allQueries) {
                options = options + '<option>' + allQueries[i] + '</option>';
            }
            queryOptions = options;
            exploitQuery();
        }
    };

    http.send('experimentID=' + experimentID);
}

function search(left) {
    //  Choose correct queryElement
    let queryElement = left ? $('#leftQuery')[0] : $('#rightQuery')[0];
    //  Which id should be passed on
    let id = left ? 'resultsL' : 'resultsR';
    
    //  Choose correct query for search
    let query = left ? $('.custom-combobox')[0].childNodes[0].value : $('.custom-combobox')[1].childNodes[0].value;

    searchDocuments(query, $('#resPerQuery').val(), $('#id').val(), id);
}

function exploitQuery() {
    
    //  Add similarity select on searchL
    $('#searchL').html('<label for="SimilarityL">Similarity: </label>' +
            '<select id="SimilarityL">' +
                '<option>BM25Similarity</option>' +
                '<option>TFIDFSimilarity</option>' +
                '<option>LMDirichletSimilarity</option>' +
                '<option>Interleaved</option>' +
                '<option value="topScoresIndependent">Top-Scores Independent</option>' +
            '</select>');
    
    //  Clear SearchR
    $('#searchR').html();
    
    let selectL = '<div id="leftQuery" class="ui-widget"><select id="combobox">' + queryOptions + '</select>';
    //  Load combobox on DOM
    $('#searchL').append(selectL);
    
    let searchL = '<button type="submit" onclick="javascript:search(true)">Search</button>' +
        '<br /><span id="leftKendallSpan"></span><br /><div id="resultsL"></div></div>';

    //  Add search button and results div
    $('#searchL').append(searchL);
    //  Enable combobox
    $('#combobox').combobox();
    //  Clear the left combobox (should be updated if the #inputs changes
    $('input')[2].value = '';
}

function checkReadyExperiments() {
    var http = new XMLHttpRequest();
    var url = "checkExperimentsServlet";
    
    http.open("POST", url, true);
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    
    http.onreadystatechange = function() {
        if(http.readyState === 4 && http.status === 200) {
            let readyExpsArr = http.responseText
                .replace(/\[/g, "").replace(/\]/g, "")
                .split(",").map(x => x.trim());
            let options = '';
            readyExpsArr.forEach((exp) => {
               options += '<option value="'+ exp +'">' + exp + '</option>';
            });
            $('#id').html(options);
            getQueriesUsed();
            return;
        }
    };

    http.send();
}

/*
 * 
 * @param {String} searchQuery Query to lucene
 * @returns {nothing}
 */
function crawlAndIndex() {
    var http = new XMLHttpRequest();
    var url = "crawlAndIndexServlet";
    
    var data = {
        "id": $('#id').val(),
        "resPerQuery": $('#resPerQuery').val(),
        "queries": $('#queries').val().split(',').map(x => x.trim())
    };
    
    http.open("POST", url, true);
    
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    
    http.onreadystatechange = function() {//Call a function when the state changes.
        if(http.readyState === 4 && http.status === 200) {
            console.log('You are probably not gonna see this, but your crawling ' +
                'and indexing is done.');
            return;
        }
    };

    http.send('parameters=' + JSON.stringify(data));
    
    alert('Your crawl and indexing has started, you will know it\'s done when the ' +
        'experiment id shows up in querying');
    
}

/*
 * This function calls the getKendallTauServlet which in turn returns the normalized
 * distance between the two arrays.
 * arr1 length should match arr2 length
 * @returns Writes the score given by the servlet on spanId
 * The score ranges from 0 to 1.
 * 0 means arr1 and arr2 are identical
 * 1 means they are as far appart as possible
 */
function getKendallTau(arr1, arr2, spanId) {
    if(arr1.length !== arr2.length) {
        alert('The 2 arrays meant to run Kendall Tau Distance on are not of same length. Aborting. See console log.');
        console.log('Arr1 length: ' + arr1.length);
        console.log('Arr2 length: ' + arr2.length);
        console.log(arr1);
        console.log(arr2);
        return;
    }
    var http = new XMLHttpRequest();
    var url = "getKendallTauServlet";
    
    http.open("POST", url, true);
    
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    
    http.onreadystatechange = function() {//Call a function when the state changes.
        if(http.readyState === 4 && http.status === 200) {
            $('#' + spanId).html('Kendall Tau Distance: ' + http.responseText);
            return;
        }
    };

    http.send('arr1=' + JSON.stringify(arr1) + '&arr2=' + JSON.stringify(arr2));
}

/*
 * 
 * @param {type} nameArr1
 * @param {type} nameArr2
 * @param {type} spanId
 * @returns {undefined}
 */
function findKendallTauDistance(nameArr1, nameArr2, spanId) {
    //  Get Kendall Tau Distance between nameArr1 and nameArr2
    
    //  Create temp primary arr
    let primaryKTDArr = [];
    let primaryNamesArr = nameArr1.slice();
    for (let i = 0; i < primaryNamesArr.length; i++) {
        primaryKTDArr.push([primaryNamesArr[i], i]);
    }

    //  Create temp secondary arr
    let secondaryKTDArr = [];
    let secondaryNamesArr = nameArr2.slice();
    for (let name in secondaryNamesArr) {
        secondaryKTDArr.push([secondaryNamesArr[name], parseInt(name)]);
    }

    let orderCount;
    //  Add secondary to primary
    orderCount = primaryNamesArr.length;
    for (let name in secondaryNamesArr) {
        if (primaryNamesArr.indexOf(secondaryNamesArr[name]) === -1) {
            primaryNamesArr.push(secondaryNamesArr[name]);
            primaryKTDArr.push([secondaryNamesArr[name], orderCount]);
            orderCount++;
        }
    }
    

    //  Add google to left
    orderCount = secondaryNamesArr.length;
    for (let name in primaryNamesArr) {
        if (secondaryNamesArr.indexOf(primaryNamesArr[name]) === -1) {
            secondaryNamesArr.push(primaryNamesArr[name]);
            secondaryKTDArr.push([primaryNamesArr[name], orderCount]);
            orderCount++;
        }
    }

    //  Rearrange secondary results
    let finalSecondaryKTDArr = [];
    for (let name in primaryNamesArr) {
        finalSecondaryKTDArr.push([primaryNamesArr[name], secondaryKTDArr[
            secondaryNamesArr.indexOf(primaryNamesArr[name])
        ][1]]);
    }

    getKendallTau(primaryKTDArr.map(x => x[1]), finalSecondaryKTDArr.map(x => x[1]), spanId);
}

/*
 * 
 * @param {String} searchQuery Query to lucene
 * @returns {nothing}
 */
function searchDocuments(searchQuery, numOfRes, id, containerId) {
    var query = searchQuery;
    //  choose similarity
    var similarity = containerId === 'resultsL' ? $('#SimilarityL').val() : $('#SimilarityR').val();
    let experimentID = $('#id').val();
    
    containerId === $('#resultsR').html('');
    
    //  Do clear up
    $('#' + containerId).html('');
    $('#dualKendallSpan').html('');
    
    var http = new XMLHttpRequest();
    var url = "searchServlet";
    var params = "query=" + query + "&numOfRes=" + numOfRes + '&id=' + id + 
        '&similarity=' + similarity + '&experimentID=' + experimentID;
    http.open("POST", url, true);
    
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    
    http.onreadystatechange = function() {//Call a function when the state changes.
        if(http.readyState === 4 && http.status === 200) {
            let resObjArr = JSON.parse(http.responseText);
            
            if (resObjArr.length === 0) {
                $('#' + containerId).append('NO RESULTS FOUND');
            }
            let counter = 1;
            resObjArr.forEach(function(res) {
                let rank = res.name.match(/\d+/)[0];
                let namesAndRanks = '';
                
                let first = true;
                res.queries.sort(function(a, b) {
                    return a.rank > b.rank;
                }).forEach(function(q) {
                    let rank = q.rank;
                    if (first) {
                        namesAndRanks += 'Score: ' + res.score + '<br />';
                        first = false;
                    }
                    let ggQuery = q.query.replace(/\+/gm, ' ')
                        .replace(rank, '')
                        .toLowerCase();
                    
                    if (ggQuery.toLowerCase() === query.toLowerCase()) {
                        namesAndRanks += '<b>';
                    }
                        
                    namesAndRanks += ggQuery + ' - #gg: ' + rank;
                    
                    if (ggQuery.toLowerCase() === query.toLowerCase()) {
                        namesAndRanks += '</b>';
                    }
                    
                    namesAndRanks += '<br />';
                });
                $('#' + containerId).append('<div>' + counter + ' ' + '<a target="_blank" href="' + 
                    res.href + '">' + res.href + '</a>' + '<br />' + namesAndRanks + 
                    '</div> <br />');
                counter = counter + 1;
            });
                       
            if (containerId === 'resultsL') {
                //  Get kendall tau distance between google and left query
                lTempNamesArr = resObjArr.map(x => x.name.toLowerCase());
                
                let tempGGKTDNamesArr = [];
                let fileName = query.toLowerCase().replace(/ /g, '+');
                for (let i = 1; i <= lTempNamesArr.length; i++) {
                    tempGGKTDNamesArr.push(fileName.concat(i));
                }
                findKendallTauDistance(tempGGKTDNamesArr, lTempNamesArr, 'leftKendallSpan');               
                
                
                var httpNew = new XMLHttpRequest();
                var urlNew = "antonymsServlet";
                var paramsNew = "query=" + query;
                httpNew.open("POST", urlNew, true);

                httpNew.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                httpNew.onreadystatechange = function() {//Call a function when the state changes.
                    if (httpNew.readyState === 4 && httpNew.status === 200) {
                        let responseJSONstr = httpNew.responseText.replace(/,]/g, ']');
                        let responseJSONobj = JSON.parse(responseJSONstr);
                        
                        //  Clear queryOptionsR
                        queryOptionsR = '';
                        cartesianProduct(responseJSONobj.exploited)
                        .forEach((dualQuery) => {
                            queryOptionsR += '<option>' + dualQuery.join(' ') + '</option>';
                        });
                        //  Add similarity select on searchR
                        $('#searchR').html('<label for="SimilarityR">Similarity: </label>' +
                                '<select id="SimilarityR">' +
                                    '<option>BM25Similarity</option>' +
                                    '<option>TFIDFSimilarity</option>' +
                                    '<option>LMDirichletSimilarity</option>' +
                                    '<option>Interleaved</option>' +
                                    '<option value="topScoresIndependent">Top-Scores Independent</option>' +
                                '</select>');

                        let selectR = '<div id="rightQuery" class="ui-widget"><select id="comboboxR">' + queryOptionsR + '</select>';
                        $('#searchR').append(selectR);

                        let searchR = '<button type="submit" onclick="javascript:search(false)">Search</button>' +
                            '<br /><span id="rightKendallSpan"></span><br /><div id="resultsR"></div></div>';


                        $('#searchR').append(searchR);
                        $('#comboboxR').combobox();
                        //  Clear the right searchbox (should be updated if the #inputs changes
                        $('input')[3].value = '';
                    }
                };
                httpNew.send(paramsNew);
            } else {
                //  Prepare arrays for Kendall Tau Analysis between left and right query
                let leftNamesArr = lTempNamesArr.slice();
                let rightNamesArr = resObjArr.map(x =>x.name.toLowerCase());
                findKendallTauDistance(leftNamesArr, rightNamesArr, 'dualKendallSpan');
                
                //  Prepare google names arr for kendall tau analysis between right and google query
                let ggNamesArr = [];
                let fileName = query.toLowerCase().replace(/ /g, '+');
                for (let i = 1; i <= rightNamesArr.length; i++) {
                    ggNamesArr.push(fileName.concat(i));
                }
                findKendallTauDistance(ggNamesArr, rightNamesArr, 'rightKendallSpan');
                
                //  Check for results that are the same on both columns
                checkForDoubles();
            }
        }
    };
    
    http.send(params);
}

// Checks if there are same results on both searches, and highlights them
function checkForDoubles() {
    resetHighlights();
    var posChildren = document.getElementById("resultsL").childNodes;
    var negChildren = document.getElementById("resultsR").childNodes;
    var numOfResP = posChildren.length;
    var numOfResN = negChildren.length;
    let leftCount = 0;
    let rightCount = 0;
    
    //  Without this constant to lower the color shift value, about 4% of the results
    //  recieve transparent background color
    let colorConstant = 5;
    
    let colorShift = baseColorHexInt / ($('#resPerQuery')[0].value + colorConstant);
    let sameCount = 0;
    for(var i = 0; i < numOfResP ; i++) {
        if(posChildren[i].tagName !== 'DIV') continue;
        leftCount++;
        for(var j = 0; j < numOfResN ; j++) {
            if(negChildren[j].tagName !== 'DIV') continue;
            rightCount++;
            //  Get href
            var href1 = document.createElement('div');
            href1 = posChildren[i].getElementsByTagName('a')[0].href;
            var href2 = document.createElement('div');
            href2 = negChildren[j].getElementsByTagName('a')[0].href;
            
            //  if they have the same href
            if(href1 === href2) {
                sameCount++;
                posChildren[i].className = "same";
                negChildren[j].className = "same";
                let color = parseInt((baseColorHexInt - colorShift * sameCount).toString(16), 16).toString(16);
                posChildren[i].style.backgroundColor = '#' + color;
                negChildren[j].style.backgroundColor = '#' + color;
                posChildren[i].innerHTML += '<span>' + 'Match #' + rightCount + '</span>' + '<br />';
                negChildren[j].innerHTML += '<span>' + 'Match #' + leftCount + '</span>' + '<br />';
            }
        }
        rightCount = 0;
    }
}

// Resets highlights
function resetHighlights() {
    var posChildren = document.getElementById("resultsL").childNodes;
    var numOfRes = posChildren.length;
    for(var i = 0; i < numOfRes; i++) {
        if(posChildren[i].className === 'same') {
            //  this a result element which had a 
            
            //  remove <br>
            posChildren[i].removeChild(posChildren[i].children[posChildren[i].children.length - 1]);
            //  remove Matches ...
            posChildren[i].removeChild(posChildren[i].children[posChildren[i].children.length - 1]);
            posChildren[i].className = "unstyled";
        }
    }
}

//  Returns all possible permutations of given array of arrays 
function cartesianProduct(arr)
{
    return arr.reduce(function(a,b){
        return a.map(function(x){
            return b.map(function(y){
                return x.concat(y);
            });
        }).reduce(function(a,b){ return a.concat(b); },[]);
    }, [[]]);
}
